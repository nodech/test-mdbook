<!DOCTYPE html>
<html lang="en">

<head>
<title>Handshake Developer Documentation</title>

<meta name="generator" content="pandoc">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<link rel="icon" type="image/ico" href="/img/favicon.ico" />
<link rel="stylesheet" type="text/css" href="/css/github-markdown.min.css" />
<link rel="stylesheet" type="text/css" href="/css/main.css" />
</head>

<body>
<header>
  <a href="/"><img alt="Handshake logo" src="/img/logo.svg" /></a>
</header>

<main>
<nav><div class="wrapper">
  <ul>
    <li><strong>INSTALL</strong></li>
    <li><a id="install-mac"   href="/guides/mac-install.html">macOS</a></li>
    <li><a id="install-linux"   href="/guides/linux-install.html">Linux</a></li>
    <li><a id="install-win"   href="/guides/win-install.html">Windows</a></li>
  </ul>
  <ul>
    <li><strong>GUIDES</strong></li>
    <li><a id="guides-config"   href="/guides/config.html">HSD Configuration</a></li>
    <li><a id="guides-events"   href="/guides/events.html">Events & Sockets</a></li>
    <li><a id="guides-claims"   href="/guides/claims.html">Name Claims</a></li>
    <li><a id="guides-auctions"   href="/guides/auctions.html">Name Auctions</a></li>
    <li><a id="guides-wallet"   href="/guides/wallet.html">Wallet Setup</a></li>
    <li><a id="guides-resource"   href="/guides/resource-records.html">HNS Resource Records</a></li>
    <li><a id="guides-resource"  class="active"  href="/guides/plugins.html">Developing Plugins</a></li>
  </ul>
  <ul>
    <li><strong>DOCUMENTATION</strong></li>
    <li><a href="/api-docs">API Docs</a></li>
    <li><a href="/hsd">Full Documentation</a></li>
  </ul>
  <ul>
    <li><strong>PROTOCOL</strong></li>
    <li><a href="/files/handshake.txt">Paper</a></li>
    <li><a id="protocol-summary"   href="/protocol/summary.html">Summary</a></li>
    <li><a id="protocol-merkle"   href="/protocol/merkle.html">Merkle Tree</a></li>
    <li><a href="/HIPs">Improvement Proposals</a></li>
  </ul>
</div></nav>

<section class="markdown-body">
<pre class="lynx">
    ___   
   /\__\  
  /:/__/_ 
 /::\/\__\
 \/\::/  /
   /:/  / 
   \/__/  
</pre>

<h1 id="developing-and-using-plugins-for-hsd">Developing and using plugins for <code>hsd</code></h1>
<p><code>hsd</code> has a plugin interface that allows developers to expand or modify any property of any module within the system, and listen for any internal events. The default wallet used by <code>hsd</code> is in fact a <a href="https://github.com/handshake-org/hsd/blob/a94ce87a886e943a68d4a3e67068f6e473c21156/lib/wallet/plugin.js">plugin</a> that is integrated by default when hsd is launched from the executable <a href="https://github.com/handshake-org/hsd/blob/a94ce87a886e943a68d4a3e67068f6e473c21156/bin/node#L39-L43"><code>bin/node</code></a>.</p>
<p>Because a plugin could easily modify consensus code, EXTREME CAUTION must be taken by users when running <code>hsd</code> with a plugin, or when developing one themselves.</p>
<p>Plugins are ingested by <code>hsd</code> at launch by passing a path to a plugin file or directory that contains a <code>package.json</code> file with a <code>"main": "&lt;relative/path/to/file&gt;"</code> property. Plugin files can be identified on the command line, in <code>hsd.conf</code> files or specified by the environment.</p>
<h2 id="example-plugin-installation-and-integration">Example plugin installation and integration:</h2>
<p>Command line:</p>
<p>(Plugins can be installed from npm directly into <code>hsd/node_modules</code>)</p>
<pre><code>$ cd hsd
$ npm install hstratum
$ hsd --plugins hstratum</code></pre>
<p>Shell environment:</p>
<pre><code>$ export HSD_PLUGINS=/Users/hsd-developer/work/holdmyhand
$ hsd</code></pre>
<p>Conf file:</p>
<p>(<code>~/.hsd/hsd.conf</code>)</p>
<pre><code>plugins: /Users/hsd-developer/work/holdmyhand</code></pre>
<h2 id="plugin-development">Plugin development</h2>
<p><code>FullNode</code>, <code>SPVNode</code> and <code>WalletNode</code> modules (which all extend <code>lib/node/node.js</code>) can load plugins. A plugin file MUST have at least the following architecture:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">class</span> Plugin <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>  <span class="at">constructor</span>(node) <span class="op">{}</span></span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a>  <span class="kw">async</span> <span class="at">open</span>() <span class="op">{}</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>  <span class="kw">async</span> <span class="at">close</span>() <span class="op">{}</span></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="kw">const</span> plugin <span class="op">=</span> exports<span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="va">plugin</span>.<span class="at">id</span> <span class="op">=</span> <span class="st">&#39;plugin_name&#39;</span><span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="va">plugin</span>.<span class="at">init</span> <span class="op">=</span> (node) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Plugin</span>(node)<span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12"></a><span class="op">};</span></span></code></pre></div>
<ul>
<li>A plugin is a class</li>
<li>Plugins must have a static function <code>init(node)</code> which takes a <code>node</code> parameter (<code>FullNode</code>, <code>SPVNode</code>, or <code>WalletNode</code>)</li>
<li>Plugins must have <code>async</code> internal methods <code>open()</code> and <code>close()</code></li>
<li>Plugins should have an <code>id</code> to name the plugin, names of existing internal modules are reserved</li>
</ul>
<p>The plugin lifecycle relative to <code>hsd</code> launch is as follows:</p>
<ol type="1">
<li><code>FullNode</code> is instantiated and populated with default modules (<code>chain</code>, <code>pool</code>, etc)</li>
<li>Event listeners are set for these internal modules</li>
<li>Plugins are loaded from the <code>config</code> module in order they are passed in</li>
<li><code>FullNode</code> is opened:
<ul>
<li><code>logger</code>, <code>workers</code>, <code>chain</code>, <code>mempool</code>, <code>miner</code> and <code>pool</code> are opened by calling <code>open()</code> on each object</li>
<li>plugins are opened by calling <code>open()</code> on each plugin</li>
<li><code>http</code>, <code>ns</code>, and <code>rs</code> are opened by calling <code>open()</code> on each object</li>
</ul></li>
<li>The process is reversed when the node is closed, calling <code>close()</code> on each object</li>
</ol>
<p>Note that this means that some modules are already opened before plugins, and so some properties may not be malleable by a plugin.</p>
<h2 id="development-tips">Development tips</h2>
<h4 id="plugins-can-share-a-logger-with-the-host-and-identify-their-own-context">Plugins can share a logger with the host, and identify their own context:</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">this</span>.<span class="at">logger</span> <span class="op">=</span> <span class="va">node</span>.<span class="va">logger</span>.<span class="at">context</span>(<span class="st">&#39;holdmyhand&#39;</span>)<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">this</span>.<span class="va">logger</span>.<span class="at">info</span>(<span class="st">&#39;Root nameserver filtering is active.&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p>Log output:</p>
<pre><code>[info] (holdmyhand) Root nameserver filtering is active.</code></pre>
<h4 id="plugins-can-listen-for-events-and-even-stub-class-methods.">Plugins can listen for events and even stub class methods.</h4>
<p>This is an example snippet of a plugin that logs all incoming and outgoing p2p packets:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">class</span> Plugin <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2"></a>  <span class="at">constructor</span>(node) <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3"></a>    <span class="kw">this</span>.<span class="at">pool</span> <span class="op">=</span> <span class="va">node</span>.<span class="at">pool</span><span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="kw">this</span>.<span class="at">init</span>()<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>  <span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6"></a></span>
<span id="cb7-7"><a href="#cb7-7"></a>  <span class="at">init</span>() <span class="op">{</span></span>
<span id="cb7-8"><a href="#cb7-8"></a>    <span class="co">// Listen for incoming packet events</span></span>
<span id="cb7-9"><a href="#cb7-9"></a>    <span class="kw">this</span>.<span class="va">pool</span>.<span class="at">on</span>(<span class="st">&#39;packet&#39;</span><span class="op">,</span> (packet) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-10"><a href="#cb7-10"></a>      <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Incoming packet: &#39;</span><span class="op">,</span> packet)<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12"></a></span>
<span id="cb7-13"><a href="#cb7-13"></a>    <span class="co">// Wait for pool to be opened</span></span>
<span id="cb7-14"><a href="#cb7-14"></a>    <span class="kw">this</span>.<span class="va">pool</span>.<span class="at">on</span>(<span class="st">&#39;peer open&#39;</span><span class="op">,</span> (peer) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-15"><a href="#cb7-15"></a></span>
<span id="cb7-16"><a href="#cb7-16"></a>      <span class="co">// Steal the existing method</span></span>
<span id="cb7-17"><a href="#cb7-17"></a>      <span class="va">peer</span>.<span class="at">SEND</span> <span class="op">=</span> <span class="va">peer</span>.<span class="at">send</span><span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18"></a></span>
<span id="cb7-19"><a href="#cb7-19"></a>      <span class="co">// Replace the method with a wrapper listening for outgoing packets</span></span>
<span id="cb7-20"><a href="#cb7-20"></a>      <span class="va">peer</span>.<span class="at">send</span> <span class="op">=</span> (packet) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="#cb7-21"></a></span>
<span id="cb7-22"><a href="#cb7-22"></a>        <span class="co">// Do something...</span></span>
<span id="cb7-23"><a href="#cb7-23"></a>        <span class="va">console</span>.<span class="at">log</span>(<span class="st">&#39;Outgoing packet: &#39;</span><span class="op">,</span> packet)<span class="op">;</span></span>
<span id="cb7-24"><a href="#cb7-24"></a></span>
<span id="cb7-25"><a href="#cb7-25"></a>        <span class="co">// ...then return the original method</span></span>
<span id="cb7-26"><a href="#cb7-26"></a>        <span class="va">peer</span>.<span class="at">SEND</span>(packet)<span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27"></a>      <span class="op">};</span></span>
<span id="cb7-28"><a href="#cb7-28"></a>    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb7-29"><a href="#cb7-29"></a>  <span class="op">}</span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="op">}</span></span></code></pre></div>
<h2 id="dns-resolver-plugins">DNS resolver plugins</h2>
<p>The HNS root authoritative name server has extra properties that give plugins more flexibilty inside the module. Users may have specific preferences for how <code>hsd</code> resolves names from the HNS root zone. Some possible modifications are:</p>
<ul>
<li>Redirect specific TLD queries to the local ICANN root resolver instead of HNS</li>
<li>Resolve blocklisted names like <code>.eth</code> or <code>.bit</code> on external systems like Ethereum or Namecoin</li>
<li>Detect and block homograph attacks</li>
</ul>
<p>The <code>hsd</code> root server module is in the repository in <a href="https://github.com/handshake-org/hsd/blob/a94ce87a886e943a68d4a3e67068f6e473c21156/lib/dns/server.js#L109"><code>lib/dns/server.js</code></a>. A plugin can access the server from an <code>hsd</code> <code>FullNode</code> or <code>SPVNode</code> from its constructor:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1"></a><span class="at">constructor</span>(node) <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="kw">this</span>.<span class="at">ns</span> <span class="op">=</span> <span class="va">node</span>.<span class="at">ns</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="op">}</span></span></code></pre></div>
<p>Once the server is instantiated the plugin can access certain properties:</p>
<h3 id="blacklist"><code>blacklist</code></h3>
<p>A <code>Set</code> of strings that will not be looked up (a <code>NXDOMAIN</code> is returned):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1"></a><span class="kw">this</span>.<span class="va">ns</span>.<span class="va">blacklist</span>.<span class="at">add</span>(<span class="st">&#39;localhost&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="getreservedtld"><code>getReserved(tld)</code></h3>
<p>A <code>function</code> that is called with a top-level domain name <code>String</code>. Returns a reserved name <code>Object</code> or <code>null</code>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">this</span>.<span class="va">ns</span>.<span class="at">getReserved</span>(<span class="st">&#39;com&#39;</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="signrrsetarraywire.record-int"><code>signRRSet(Array[wire.Record], Int)</code></h3>
<p>A <code>function</code> that is called with an RR set (<code>Array[wire.Record]</code>) and type (<code>wire.types</code>) that signs the set with the HNS root ZSK and pushes the RRSIG back onto the answer (there is no return value).</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">this</span>.<span class="va">ns</span>.<span class="at">signRRSet</span>(<span class="va">res</span>.<span class="at">answer</span><span class="op">,</span> type)<span class="op">;</span></span></code></pre></div>
<h3 id="middlestring-wire.message-object"><code>middle(String, wire.Message, Object)</code></h3>
<p>An optional <code>function</code>, settable by a plugin, that is called with the TLD, the full request, and the request info <em>before</em> checking the cache, the blacklist, the HNS root zone, or the ICANN reserved TLD list. <code>rinfo</code> is a JSON object passed from the DNS Server and has the following shape:</p>
<pre><code>{
  tcp: (bool),
  family: (string, &quot;IPv4&quot; or &quot;IPv6&quot;),
  address: (string, IP address),
  port: (int, port number)
};</code></pre>
<p>If there is no function provided or if the provided function returns <code>null</code>, the root resolver lookup proceeds as by default. The function may also return a <a href="https://github.com/chjj/bns/blob/25a2330322b740fa96ed67e5c0d8f0a1de89da55/lib/wire.js#L165"><code>Message</code></a> which is then returned directly to the resolver that made the query. Records in these responses will appear to come directly from the HNS root zone, so they should be flagged as authoritative where applicable and signed by the HNS root zone-signing key where applicable.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">this</span>.<span class="va">ns</span>.<span class="at">middle</span> <span class="op">=</span> (tld<span class="op">,</span> req<span class="op">,</span> rinfo) <span class="kw">=&gt;</span> <span class="op">{</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="kw">const</span> [qs] <span class="op">=</span> <span class="va">req</span>.<span class="at">question</span><span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a>  <span class="kw">const</span> name <span class="op">=</span> <span class="va">qs</span>.<span class="va">name</span>.<span class="at">toLowerCase</span>()<span class="op">;</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>  <span class="kw">const</span> type <span class="op">=</span> <span class="va">qs</span>.<span class="at">type</span><span class="op">;</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>  <span class="kw">const</span> wire <span class="op">=</span> <span class="kw">this</span>.<span class="va">ns</span>.<span class="at">wire</span><span class="op">;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a></span>
<span id="cb13-7"><a href="#cb13-7"></a>  <span class="cf">if</span> (tld <span class="op">===</span> <span class="st">&#39;bit&#39;</span>) <span class="op">{</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="kw">const</span> res <span class="op">=</span> <span class="kw">new</span> <span class="va">wire</span>.<span class="at">Message</span>()<span class="op">;</span></span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a>    <span class="co">// Lookup the full name from the request using a Namecoin full node</span></span>
<span id="cb13-11"><a href="#cb13-11"></a>    <span class="va">res</span>.<span class="at">answer</span> <span class="op">=</span> <span class="kw">this</span>.<span class="va">namecoinClient</span>.<span class="at">lookup</span>(name)<span class="op">;</span></span>
<span id="cb13-12"><a href="#cb13-12"></a></span>
<span id="cb13-13"><a href="#cb13-13"></a>    <span class="co">// Sign the answer with the HNS root ZSK</span></span>
<span id="cb13-14"><a href="#cb13-14"></a>    <span class="kw">this</span>.<span class="va">ns</span>.<span class="at">signRRSet</span>(<span class="va">res</span>.<span class="at">answer</span><span class="op">,</span> type)<span class="op">;</span></span>
<span id="cb13-15"><a href="#cb13-15"></a></span>
<span id="cb13-16"><a href="#cb13-16"></a>    <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>  <span class="op">}</span></span>
<span id="cb13-18"><a href="#cb13-18"></a></span>
<span id="cb13-19"><a href="#cb13-19"></a>  <span class="co">// Bypass if the plugin doesn&#39;t care about the name</span></span>
<span id="cb13-20"><a href="#cb13-20"></a>  <span class="cf">return</span> <span class="kw">null</span><span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21"></a><span class="op">}</span></span></code></pre></div>

<hr/>
<h4>See a mistake? Open a pull request.</h4>
<a href="https://github.com/handshake-org/handshake-org.github.io/blob/master/src/guides/plugins.md">https://github.com/handshake-org/handshake-org.github.io/blob/master/src/guides/plugins.md</a>
</section>
</main>

<footer id="footer">
  &copy;&nbsp;2018 Handshake Community<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">(Creative Commons Attribution-ShareAlike 4.0 International License)</a>
</footer>
</body>

</html>
